name: EOL Nightly Build

on:
  schedule:
    # 每天 UTC 02:00 运行（北京时间 10:00）
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip cargo test (for emergency build)'
        required: false
        default: 'false'

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-A warnings"  # 允许所有警告，灵魂保留

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        target: x86_64-pc-windows-gnu

    - name: Extract version and date
      id: version
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        
        $tag = git describe --tags --abbrev=0 2>$null
        if (-not $tag) {
          $shortSha = $env:GITHUB_SHA.Substring(0,7)
          $tag = "v0.0.0+$shortSha"
          Write-Host "No tags found, using: $tag"
        } else {
          Write-Host "Found tag: $tag"
        }
        
        $date = Get-Date -Format "yyyyMMdd"
        $baseName = "eol-$tag-build$date"
        
        "TAG=$tag" >> $env:GITHUB_OUTPUT
        "DATE=$date" >> $env:GITHUB_OUTPUT
        "BASENAME=$baseName" >> $env:GITHUB_OUTPUT

    - name: Run cargo test
      if: github.event.inputs.skip_tests != 'true'
      run: cargo test --release --verbose

    - name: Build Release
      run: cargo build --release --verbose

    - name: Package artifacts
      id: package
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        $baseName = "${{ steps.version.outputs.BASENAME }}"
        
        # 确定构建目录（优先 release）
        $buildDir = "target/release"
        if (-not (Test-Path "$buildDir/eolc.exe")) {
          Write-Host "Error: Release build not found"
          exit 1
        }
        
        Write-Host "Packaging from: $buildDir"
        
        # 创建临时目录结构
        New-Item -ItemType Directory -Force -Path "packaging/full/lib"
        New-Item -ItemType Directory -Force -Path "packaging/full/mingw-minimal"
        New-Item -ItemType Directory -Force -Path "packaging/full/llvm-minimal"
        New-Item -ItemType Directory -Force -Path "packaging/core"
        
        # 复制完整版内容
        Copy-Item -Path "lib/*" -Destination "packaging/full/lib/" -Recurse -Force
        Copy-Item -Path "mingw-minimal/*" -Destination "packaging/full/mingw-minimal/" -Recurse -Force
        Copy-Item -Path "llvm-minimal/*" -Destination "packaging/full/llvm-minimal/" -Recurse -Force
        Copy-Item -Path "$buildDir/eolc.exe" -Destination "packaging/full/" -Force
        Copy-Item -Path "$buildDir/eolll.exe" -Destination "packaging/full/" -Force
        Copy-Item -Path "$buildDir/ir2exe.exe" -Destination "packaging/full/" -Force
        
        # 复制核心版内容（仅 exe）
        Copy-Item -Path "$buildDir/eolc.exe" -Destination "packaging/core/" -Force
        Copy-Item -Path "$buildDir/eolll.exe" -Destination "packaging/core/" -Force
        Copy-Item -Path "$buildDir/ir2exe.exe" -Destination "packaging/core/" -Force
        
        # 创建 zip 文件
        $fullName = "${baseName}-win86-64-mingw64-llvm21.zip"
        $coreName = "${baseName}-win86-64-core.zip"
        
        Compress-Archive -Path "packaging/full/*" -DestinationPath $fullName -Force
        Compress-Archive -Path "packaging/core/*" -DestinationPath $coreName -Force
        
        Write-Host "Created: $fullName"
        Write-Host "Created: $coreName"
        
        "FULL_ZIP=$fullName" >> $env:GITHUB_OUTPUT
        "CORE_ZIP=$coreName" >> $env:GITHUB_OUTPUT

    - name: Delete previous nightly tag (if exists)
      shell: pwsh
      run: |
        git tag -d nightly-latest 2>$null
        git push origin :refs/tags/nightly-latest 2>$null
        Write-Host "Cleaned up old nightly tag"

    - name: Create Pre-Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: nightly-latest
        name: "EOL Nightly ${{ steps.version.outputs.TAG }} (${{ steps.version.outputs.DATE }})"
        body: |
          **预发布版本** | Pre-release Build
          
          - 版本: `${{ steps.version.outputs.TAG }}`
          - 日期: `${{ steps.version.outputs.DATE }}`
          - 提交: `${{ github.sha }}`
          
          ## 文件说明
          | 文件名 | 说明 |
          |--------|------|
          | `*-win86-64-mingw64-llvm21.zip` | **完整版**：含 lib, mingw-minimal, llvm-minimal 工具链 |
          | `*-win86-64-core.zip` | **核心版**：仅 eolc.exe, eolll.exe, ir2exe.exe |
          
        files: |
          eol-*.zip
        prerelease: true
        fail_on_unmatched_files: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}